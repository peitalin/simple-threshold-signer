name: ci

on:
  push:
  pull_request:
  merge_group:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies (workspace)
        run: pnpm install --no-frozen-lockfile

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Add Rust components (rustfmt + clippy)
        run: rustup component add rustfmt clippy

      - name: Add wasm32 target
        run: rustup target add wasm32-unknown-unknown

      - name: Install wasm-pack
        run: |
          curl -sSf https://rustwasm.github.io/wasm-pack/installer/init.sh | sh

      - name: Generate WASM TypeScript types (wasm-pack)
        run: pnpm -C sdk exec bash ./scripts/generate-types.sh

      - name: Check (lint + format + type-check)
        run: pnpm check

      - name: Setup Bun (for worker bundling)
        uses: oven-sh/setup-bun@v2

      - name: Install Playwright (Chromium + system deps)
        run: pnpm -C sdk exec playwright install --with-deps chromium

      - name: Build SDK (production)
        run: pnpm build:sdk-prod

      - name: Assert generated palette CSS
        run: node sdk/scripts/assert-palette-css.mjs

      - name: Run lite SDK tests
        run: pnpm test:lite

      - name: Run relayer (server) tests
        run: pnpm -C sdk test:relayer

  threshold-signing-core:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: tatchi
          POSTGRES_PASSWORD: tatchi
          POSTGRES_DB: tatchi
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U tatchi -d tatchi"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 12
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 12
    env:
      POSTGRES_URL: postgres://tatchi:tatchi@127.0.0.1:5432/tatchi
      REDIS_URL: redis://127.0.0.1:6379
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies (workspace)
        run: pnpm install --no-frozen-lockfile

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Add wasm32 target
        run: rustup target add wasm32-unknown-unknown

      - name: Install wasm-pack
        run: |
          curl -sSf https://rustwasm.github.io/wasm-pack/installer/init.sh | sh

      - name: Setup Bun (for worker bundling)
        uses: oven-sh/setup-bun@v2

      - name: Install Playwright (Chromium + system deps)
        run: pnpm -C sdk exec playwright install --with-deps chromium

      - name: Build SDK (production)
        run: pnpm build:sdk-prod

      - name: Smoke check eth_signer runtime loading (Node + Workers)
        run: pnpm -C sdk smoke:eth-signer:runtimes

      - name: Run threshold signing core suites
        run: pnpm test:threshold-core

      - name: Upload threshold-core test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: threshold-core-artifacts-${{ github.run_id }}-${{ github.run_attempt }}
          if-no-files-found: ignore
          path: |
            sdk/playwright-report
            sdk/test-results

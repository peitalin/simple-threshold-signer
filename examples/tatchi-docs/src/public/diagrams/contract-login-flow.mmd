sequenceDiagram
    box Iframe Wallet
    participant Wallet as Wallet
    participant Worker as SecureConfirm Worker
    end
    participant Relay as Relay Server (Optional)

    Note over Wallet,Worker: Phase 1: Load Encrypted SecureConfirm
    Wallet->>Wallet: 1. Retrieve encrypted SecureConfirm from IndexedDB

    Note over Wallet,Relay: Phase 2: SecureConfirm Unlock (Two Options)

    alt Option A: Shamir 3-Pass Unlock (No TouchID)
        Wallet->>Relay: 2a. Request Shamir 3-pass decrypt
        Relay->>Wallet: Server KEK component
        Wallet->>Worker: 3a. Decrypt SecureConfirm with combined KEK
        Worker->>Worker: 4a. SecureConfirm keypair loaded into memory
        Worker->>Wallet: 5a. SecureConfirm session active ✓
        Note over Wallet: No biometric prompt required
    else Option B: WebAuthn Unlock (TouchID Fallback)
        Wallet->>Wallet: 2b. WebAuthn authentication (TouchID prompt)
        Note over Wallet: PRF extension returns chacha20 output
        Wallet->>Worker: 3b. Decrypt SecureConfirm with PRF output
        Worker->>Worker: 4b. SecureConfirm keypair loaded into memory
        Worker->>Wallet: 5b. SecureConfirm session active ✓
        Note over Wallet,Relay: Optional: Refresh Shamir encryption
        Wallet->>Relay: 6b. Store new server-encrypted SecureConfirm
    end

    Note over Wallet,Relay: Phase 3: Optional JWT Session
    opt Mint JWT for web2 auth
        Wallet->>Worker: 7. Generate fresh SecureConfirm challenge
        Worker->>Wallet: SecureConfirm challenge + proof
        Wallet->>Wallet: 8. WebAuthn authentication (TouchID prompt)
        Wallet->>Relay: 9. Verify authentication + SecureConfirm proof
        Relay->>Wallet: 10. JWT token
    end

    Note over Wallet,Worker: SecureConfirm unlocked - ready to generate WebAuthn challenges

sequenceDiagram
    box rgb(243, 244, 246) Iframe Wallet
    participant Wallet as Wallet
    participant Worker as SecureConfirm Worker
    end
    participant Relay as Relay Server (Optional)

    Note over Wallet,Worker: Phase 1: Load Encrypted SecureConfirm
    Wallet->>Wallet: 1. Retrieve encrypted SecureConfirm from IndexedDB

    Note over Wallet,Relay: Phase 2: WebAuthn Unlock (TouchID Fallback)
    Wallet->>Wallet: 2. WebAuthn authentication (TouchID prompt)
    Note over Wallet: PRF extension returns chacha20 output
    Wallet->>Worker: 3. Decrypt SecureConfirm with PRF output
    Worker->>Worker: 4. SecureConfirm keypair loaded into memory
    Worker->>Wallet: 5. SecureConfirm session active âœ“
    Note over Wallet,Relay: Optional: Refresh Shamir encryption
    Wallet->>Relay: 6. Store new server-encrypted SecureConfirm

    Note over Wallet,Worker: SecureConfirm unlocked - ready to generate WebAuthn challenges

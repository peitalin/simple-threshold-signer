sequenceDiagram
    box rgb(243, 244, 246) Iframe Wallet
    participant JSMain as JS Main Thread
    participant Worker as WASM Worker
    end
    participant NEAR as NEAR RPC
    participant Contract as Web3Authn Contract

    Note over JSMain,Worker: Phase 1: Bootstrap SecureConfirm Challenge
    JSMain->>NEAR: 1. Get block height + hash from RPC
    NEAR->>JSMain: Block data
    JSMain->>Worker: 2. generateSecureConfirmKeypairBootstrap()
    Worker->>Worker: 3. Generate bootstrap SecureConfirm keypair (temporary)
    Worker->>Worker: 4. Generate SecureConfirm proof + output (challenge)
    Worker->>JSMain: 5. SecureConfirm challenge for WebAuthn ceremony

    Note over JSMain,Worker: Phase 2: WebAuthn Registration with Dual PRF
    JSMain->>Worker: 6. requestRegistrationCredentialConfirmation()
    Note over Worker: WebAuthn registration (TouchID prompt)<br/>PRF extension returns dual outputs:<br/>first=chacha20, second=ed25519
    Worker->>JSMain: Registration credential

    Note over JSMain,Worker: Phase 3: Derive Deterministic Keys from PRF
    JSMain->>Worker: 7. deriveSecureConfirmKeypairFromRawPrf(ed25519PrfOutput)
    Worker->>Worker: 8. Derive deterministic SecureConfirm keypair from PRF
    Worker->>Worker: 9. Encrypt deterministic SecureConfirm with ChaCha20-Poly1305
    Worker->>JSMain: 10. Encrypted deterministic SecureConfirm keypair

    JSMain->>Worker: 11. deriveNearKeypairFromDualPrf(chacha20PrfOutput)
    Worker->>Worker: 12. Derive NEAR ed25519 keypair from PRF
    Worker->>Worker: 13. Encrypt NEAR keypair with ChaCha20-Poly1305
    Worker->>JSMain: 14. NEAR public key + encrypted keypair

    Note over JSMain,Contract: Phase 4: Contract Registration
    Note over JSMain: Routed through relayer to pay for gas
    JSMain->>Contract: 15. create_account_and_register_user()
    Contract->>Contract: 16. Registration verified
    Contract->>JSMain: 17. Registration complete (txId)

    Note over JSMain,Worker: Phase 5: Client-side Storage
    JSMain->>JSMain: 18. Store encrypted deterministic SecureConfirm in IndexedDB
    JSMain->>JSMain: 19. Store encrypted NEAR keypair in IndexedDB
    JSMain->>JSMain: 20. Registration complete âœ“
